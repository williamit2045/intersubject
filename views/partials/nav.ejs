<!-- views/partials/nav.ejs -->
<nav class="nav-bar">
  <div class="nav-container">
    <div class="nav-top">
      <a href="/" class="nav-logo" aria-label="Intersubject Home">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10" />
          <circle cx="12" cy="12" r="4" />
          <line x1="12" y1="2" x2="12" y2="22" />
          <line x1="2" y1="12" x2="22" y2="12" />
        </svg>
      </a>

      <!-- NAV SEARCH -->
      <div class="search-container">
        <div class="nav-search">
          <input type="text" placeholder="Search cohorts." id="nav-search-input" class="search-input" autocomplete="off">
          <div class="search-results-dropdown" id="nav-search-results"></div>
        </div>
      </div>
    </div>

    <!-- NAV LINKS -->
    <ul class="nav-links">
      <% if (user) { %>
        <li>
          <button class="toggle-btn" id="express-btn" data-section="express">Create New Cohort</button>
        </li>
      <% } %>
      <li><a href="/public">Public</a></li>
      <% if (user) { %>
        <li><a href="/personal">Personal</a></li>
        <li><a href="/auth/logout">Logout</a></li>
      <% } else { %>
        <li><button class="toggle-btn" data-section="login">Login</button></li>
      <% } %>
    </ul>
  </div>

  <!-- Express form overlay -->
  <div class="overlay" id="express" aria-hidden="true">
    <div class="form-content" role="dialog" aria-modal="true" aria-labelledby="express-title">
      <h2 id="express-title">Express Yourself</h2>
      <% if (user) { %>
        <form id="express-form" action="/expressions/create" method="POST">
          <p>Enter a statement that represents you:</p>
          <textarea 
            name="text" 
            placeholder="Examples: 'I work in tech', 'I love hiking', 'I believe in climate action'"
            rows="3" 
            required
          ></textarea>
          <button type="submit" class="btn">Create Expression</button>
        </form>
      <% } else { %>
        <p>For this version, please log in to speak for yourself, individually, and collectively.</p>
        <button class="btn toggle-btn" data-section="login">Login</button>
      <% } %>
    </div>
  </div>

  <!-- Login Overlay -->
  <div class="overlay" id="login" aria-hidden="true">
    <div class="form-content" role="dialog" aria-modal="true" aria-labelledby="login-title">
      <h2 id="login-title">Login</h2>
      <form action="/auth/login" method="POST">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required>
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
        <button type="submit" class="btn">Login</button>
      </form>
      <p class="muted-link" style="margin-top:1rem;">
        Don't have an account? <a href="/">Register here</a>
      </p>
    </div>
  </div>
</nav>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const navSearchInput = document.getElementById('nav-search-input');
    const navSearchResults = document.getElementById('nav-search-results');

    navSearchInput.addEventListener('input', function() {
      const query = this.value.trim();
      if (query.length < 2) {
        navSearchResults.innerHTML = '';
        navSearchResults.style.display = 'none';
        return;
      }
      fetch(`/api/expressions/search?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
          navSearchResults.innerHTML = '';
          if (data.length === 0) {
            navSearchResults.style.display = 'none';
            return;
          }
          data.forEach(expression => {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.innerHTML = expression.text;
            item.addEventListener('click', () => {
              window.location.href = `/explore/${expression.id}`;
            });
            navSearchResults.appendChild(item);
          });
          navSearchResults.style.display = 'block';
        })
        .catch(err => console.error('Search error:', err));
    });

    document.addEventListener('click', function(event) {
      if (!navSearchInput.contains(event.target) && !navSearchResults.contains(event.target)) {
        navSearchResults.style.display = 'none';
      }
    });
  });
</script>
<script src="/js/auth.js"></script>
